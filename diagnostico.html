<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrderFlow - Diagnóstico Inteligente</title>
    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Open+Sans:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="faviconorderflow.png">
    <style>
        .diagnostic-card {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #444;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            height: 6px;
            background: #444;
            border-radius: 3px;
            overflow: hidden;
            width: 100%;
        }

        .progress-fill {
            height: 100%;
            background: #47a2e8;
            width: 0%;
            transition: width 0.5s ease;
        }

        .question-container {
            min-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #47a2e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .question-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 25px;
            font-family: 'Inter', sans-serif;
        }

        .question-subtitle {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 12px;
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .option-btn:hover {
            border-color: #47a2e8;
            background: #444;
        }

        .option-btn.selected {
            border-color: #47a2e8;
            background: rgba(71, 162, 232, 0.15);
        }

        .option-btn .emoji {
            margin-right: 10px;
        }

        .text-input,
        .textarea-input {
            width: 100%;
            padding: 15px;
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            margin-top: 12px;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        .textarea-input {
            min-height: 100px;
            resize: vertical;
        }

        .text-input:focus,
        .textarea-input:focus {
            outline: none;
            border-color: #47a2e8;
        }

        .text-input::placeholder,
        .textarea-input::placeholder {
            color: #888;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .nav-btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .nav-btn.back {
            background: transparent;
            border: 2px solid #555;
            color: #aaa;
        }

        .nav-btn.back:hover {
            border-color: #888;
            color: #fff;
        }

        .nav-btn.next {
            background: #47a2e8;
            border: 2px solid #47a2e8;
            color: #fff;
            flex: 1;
            max-width: 200px;
        }

        .nav-btn.next:hover {
            background: #3a8ed0;
        }

        .nav-btn.next:disabled {
            background: #555;
            border-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .contact-field {
            margin-bottom: 20px;
        }

        .contact-field label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: 500;
        }

        .contact-field input {
            width: 100%;
            padding: 12px 15px;
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .contact-field input:focus {
            outline: none;
            border-color: #47a2e8;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #47a2e8;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #3a8ed0;
        }

        .submit-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .success-message {
            text-align: center;
            padding: 40px 20px;
        }

        .success-message h2 {
            color: #2ecc71;
            margin-bottom: 15px;
        }

        .success-message p {
            color: #ccc;
            font-size: 1.1rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            border-color: #47a2e8;
        }

        .checkbox-item.selected {
            border-color: #47a2e8;
            background: rgba(71, 162, 232, 0.15);
        }

        .checkbox-item input {
            display: none;
        }

        .checkbox-item span {
            color: #fff;
            font-size: 0.95rem;
        }

        .privacy-note {
            background: rgba(71, 162, 232, 0.1);
            border: 1px solid rgba(71, 162, 232, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .section-divider {
            border-top: 1px solid #444;
            margin: 25px 0;
            padding-top: 20px;
        }

        .section-label {
            color: #47a2e8;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo" style="font-family: 'Inter', sans-serif;">OrderFlow</div>
        <input type="checkbox" id="menu-toggle" style="display:none;">
        <label for="menu-toggle" class="menu-icon"><span></span><span></span><span></span></label>
        <nav>
            <a href="index.html" style="font-family: 'Inter', sans-serif;">Inicio</a>
            <a href="sobre-nosotros.html" style="font-family: 'Inter', sans-serif;">Sobre Nosotros</a>
            <a href="servicios.html" style="font-family: 'Inter', sans-serif;">Servicios</a>
            <a href="analisis-negocio.html" class="nav-cta active"
                style="font-family: 'Inter', sans-serif;">Diagnóstico</a>
            <a href="contacto.html" style="font-family: 'Inter', sans-serif;">Contacto</a>
        </nav>
    </header>

    <main>
        <section class="hero" style="text-align:center; padding: 60px 20px 40px;">
            <h1 style="font-family: 'Inter', sans-serif; margin-bottom: 15px; color: #fff;">Diagnóstico Inteligente de
                Procesos</h1>
            <p style="max-width: 600px; margin: 0 auto; line-height: 1.6; font-size: 1.1rem; color: #ccc;">
                Responde a unas preguntas rápidas para entender cómo funciona tu empresa y detectar oportunidades de
                automatización.
            </p>
        </section>

        <section class="content" style="padding: 20px; padding-bottom: 80px;">
            <div class="diagnostic-card">
                <div class="progress-container">
                    <div
                        style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #aaa;">
                        <span>Progreso</span>
                        <span id="progress-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
                <div id="diagnostic-container" class="question-container">
                    <div style="text-align: center; color: #888;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 20px;">Iniciando diagnóstico...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer
        style="background:#000; color:white; text-align:center; padding:20px; margin-top:40px; width:100%; position:static;">
        <p style="margin:0;">© 2025 OrderFlow. Todos los derechos reservados.</p>
    </footer>

    <style>
        .menu-icon {
            display: none;
            flex-direction: column;
            cursor: pointer;
            width: 32px;
            height: 32px;
            justify-content: center;
            align-items: center;
            margin-left: 20px;
            z-index: 101;
        }

        .menu-icon span {
            height: 4px;
            width: 28px;
            background: white;
            margin: 4px 0;
            border-radius: 2px;
            display: block;
            transition: 0.3s;
        }

        @media (max-width: 700px) {
            nav {
                position: absolute;
                top: 60px;
                left: 0;
                width: 100vw;
                background: #000;
                flex-direction: column;
                align-items: flex-start;
                padding: 20px 0 10px 30px;
                display: none;
                z-index: 100;
            }

            header {
                flex-direction: row;
                padding: 15px 20px;
            }

            .menu-icon {
                display: flex;
            }

            #menu-toggle:checked+.menu-icon+nav {
                display: flex;
            }

            nav a {
                margin: 10px 0;
                padding: 10px 0;
                width: 100%;
                border-radius: 0;
            }
        }

        nav a.nav-cta {
            background: #47a2e8;
            color: white !important;
            border: 1px solid #47a2e8;
            border-radius: 8px;
            padding: 8px 20px !important;
            font-weight: 500;
            margin-left: 30px;
            box-shadow: 0 0 15px rgba(71, 162, 232, 0.8), 0 4px 14px rgba(71, 162, 232, 0.4);
            transition: all 0.3s ease;
            display: inline-block;
        }

        nav a.nav-cta:hover {
            background: #0078d4;
            border-color: #0078d4;
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(71, 162, 232, 1), 0 6px 20px rgba(0, 120, 212, 0.6);
            text-decoration: none;
        }

        @media (max-width: 700px) {
            nav a.nav-cta {
                margin-left: 0;
                margin-top: 10px;
                width: fit-content;
            }
        }
    </style>

    <script>
        // =============================================
        // DIAGNOSTIC FLOW SYSTEM - COMPLETE VERSION
        // =============================================

        let currentStep = 0;
        let answers = {};
        let questionFlow = [];

        const container = document.getElementById('diagnostic-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        // Sectores
        const SECTORES = {
            RESTAURANTE: 'restaurante',
            ECOMMERCE: 'ecommerce',
            SERVICIOS: 'servicios',
            OTRO: 'otro'
        };

        // Areas
        const AREAS = {
            VENTAS: 'ventas',
            MARKETING: 'marketing',
            OPERACIONES: 'operaciones',
            ADMINISTRACION: 'administracion'
        };

        // Preguntas por sector y área
        const PREGUNTAS_VENTAS = {
            [SECTORES.RESTAURANTE]: [
                { id: 'v_canales', q: '¿Por qué canales entran actualmente los pedidos?', type: 'multi', opts: ['Sala', 'Teléfono', 'WhatsApp', 'Plataformas externas (Uber, Glovo, etc.)'] },
                { id: 'v_perdidos', q: '¿Se pierden pedidos por falta de respuesta?', type: 'single', opts: ['Sí, con frecuencia', 'A veces', 'No', 'No lo sé'] },
                { id: 'v_registro', q: '¿Cómo se registran los pedidos?', type: 'multi', opts: ['Manual', 'TPV'] }
            ],
            [SECTORES.ECOMMERCE]: [
                { id: 'v_plataforma', q: '¿Qué plataforma utilizas para vender?', type: 'single', opts: ['Shopify', 'WooCommerce', 'Otra'] },
                { id: 'v_perdidas', q: '¿Dónde se pierden más ventas?', type: 'single', opts: ['Carritos abandonados', 'Falta de repetición de clientes', 'Atención al cliente', 'No lo sé'] },
                { id: 'v_horario', q: '¿Respondes a clientes fuera de horario laboral?', type: 'single', opts: ['Sí', 'No'] }
            ],
            [SECTORES.SERVICIOS]: [
                { id: 'v_leads', q: '¿Cómo entran los leads?', type: 'multi', opts: ['WhatsApp', 'Web', 'Redes', 'Referidos'] },
                { id: 'v_seguimiento', q: '¿Pierdes leads por falta de seguimiento?', type: 'single', opts: ['Sí', 'No', 'No lo sé'] },
                { id: 'v_respuesta', q: '¿Respondes siempre rápido a los clientes?', type: 'single', opts: ['Sí', 'A veces', 'No'] }
            ],
            [SECTORES.OTRO]: [
                { id: 'v_ingresos', q: '¿Cómo generan ingresos principalmente?', type: 'multi', opts: ['Servicios', 'Productos físicos', 'Productos digitales'] },
                { id: 'v_clientes', q: '¿Cómo llegan normalmente los clientes?', type: 'multi', opts: ['Recomendaciones', 'Web', 'Redes', 'WhatsApp', 'Otra'] }
            ]
        };

        const PREGUNTAS_MARKETING = {
            [SECTORES.RESTAURANTE]: [
                { id: 'm_resenas', q: '¿Pides reseñas a tus clientes?', type: 'conditional', opts: ['No', 'Sí'], subQ: { trigger: 'Sí', id: 'm_resenas_tipo', q: '¿Cómo las pides?', opts: ['Manual', 'Automático'] } },
                { id: 'm_bbdd', q: '¿Tienes base de datos de clientes?', type: 'single', opts: ['No', 'Sí, pero no la uso', 'Sí, y la uso para promociones'] },
                { id: 'm_retorno', q: '¿Realizas acciones para que los clientes vuelvan?', type: 'single', opts: ['No', 'Sí, manual', 'Sí, automatizado'] }
            ],
            [SECTORES.ECOMMERCE]: [
                { id: 'm_postcompra', q: '¿Tienes automatizaciones post-compra?', type: 'single', opts: ['No', 'Básicas', 'Avanzadas'] },
                { id: 'm_canales', q: '¿Usas email o WhatsApp para marketing?', type: 'single', opts: ['No', 'Sí, manual', 'Sí, automatizado'] },
                { id: 'm_segmenta', q: '¿Segmentas a tus clientes para promociones?', type: 'single', opts: ['No', 'Parcial', 'Sí'] }
            ],
            [SECTORES.SERVICIOS]: [
                { id: 'm_autofollow', q: '¿Tienes seguimiento de leads?', type: 'conditional', opts: ['No', 'Sí'], subQ: { trigger: 'Sí', id: 'm_autofollow_tipo', q: '¿Cómo lo haces?', opts: ['Manual', 'Automático'] } },
                { id: 'm_nurture', q: '¿Nutres a los leads que no compran de inmediato?', type: 'conditional', opts: ['No', 'Sí'], subQ: { trigger: 'Sí', id: 'm_nurture_tipo', q: '¿Cómo lo haces?', opts: ['Manual', 'Automático'] } }
            ],
            [SECTORES.OTRO]: [
                { id: 'm_bbdd', q: '¿Tienes base de datos de clientes/leads?', type: 'single', opts: ['Sí', 'No', 'Parcial'] },
                { id: 'm_retencion', q: '¿Realizas acciones para retener clientes o generar repetición?', type: 'single', opts: ['No', 'Sí, manual', 'Sí, automatizado'] },
                { id: 'm_metricas', q: '¿Mides el impacto de tus acciones de marketing?', type: 'single', opts: ['No', 'Sí, parcialmente', 'Sí'] }
            ]
        };

        const PREGUNTAS_OPS = {
            [SECTORES.RESTAURANTE]: [
                { id: 'o_reservas', q: '¿Cómo gestionas reservas y pedidos?', type: 'multi', opts: ['Manual', 'Herramienta'] },
                { id: 'o_problemas', q: '¿Qué problemas operativos son más comunes?', type: 'multi', opts: ['Retrasos', 'Pedidos mal apuntados', 'Falta de seguimiento', 'Ninguno'] }
            ],
            [SECTORES.ECOMMERCE]: [
                { id: 'o_gestion', q: '¿Cómo gestionas pedidos, envíos y devoluciones?', type: 'single', opts: ['Manual', 'Semi-automático', 'Automatizado'] },
                { id: 'o_avisos', q: '¿Tienes avisos automáticos de incidencias?', type: 'single', opts: ['Sí', 'No'] }
            ],
            [SECTORES.SERVICIOS]: [
                { id: 'o_citas', q: '¿Cómo gestionas citas o proyectos?', type: 'multi', opts: ['Manual', 'Software'] },
                { id: 'o_recordatorios', q: '¿Existen recordatorios automáticos?', type: 'single', opts: ['Sí', 'No'] },
                { id: 'o_olvidos', q: '¿Cuántas citas se pierden por olvidos?', type: 'single', opts: ['Muchas', 'Algunas', 'Ninguna'] }
            ],
            [SECTORES.OTRO]: [
                { id: 'o_entrega', q: '¿Cómo se gestiona actualmente el servicio o entrega?', type: 'single', opts: ['Manual', 'Semi-automático', 'Automatizado'] },
                { id: 'o_tareas', q: '¿Hay tareas repetitivas hechas manualmente?', type: 'single', opts: ['Sí', 'No'] },
                { id: 'o_errores', q: '¿Existen errores frecuentes por falta de proceso?', type: 'single', opts: ['Sí', 'No'] }
            ]
        };

        const PREGUNTAS_ADMIN = {
            [SECTORES.RESTAURANTE]: [
                { id: 'a_facturacion', q: '¿Cómo gestionas facturación y cierres?', type: 'single', opts: ['Manual', 'Software', 'Asesoría externa'] },
                { id: 'a_visibilidad', q: '¿Tienes visibilidad de ventas diarias, pedidos por canal y reseñas negativas?', type: 'single', opts: ['Sí', 'Parcial', 'No'] }
            ],
            [SECTORES.ECOMMERCE]: [
                { id: 'a_factura_auto', q: '¿Facturación automática?', type: 'single', opts: ['Sí', 'No'] },
                { id: 'a_metricas', q: '¿Tienes métricas claras del negocio?', type: 'single', opts: ['Sí', 'Parcial', 'No'] }
            ],
            [SECTORES.SERVICIOS]: [
                { id: 'a_cobros', q: '¿Cómo gestionas cobros y facturación?', type: 'single', opts: ['Manual', 'Herramienta', 'Asesoría'] },
                { id: 'a_control', q: '¿Tienes control claro del estado de cada cliente?', type: 'single', opts: ['Sí', 'No'] }
            ],
            [SECTORES.OTRO]: [
                { id: 'a_gestion', q: '¿Cómo llevas la facturación, cobros y métricas?', type: 'single', opts: ['Manual', 'Herramienta', 'Parcialmente automatizado'] }
            ]
        };

        const DETALLE_AREA = {
            [AREAS.VENTAS]: { q: '¿Cuál es el mayor reto de tus ventas actualmente?', hint: '(pérdida de clientes, seguimiento, cierre, canales, etc.)' },
            [AREAS.MARKETING]: { q: '¿Qué aspecto de tu marketing te gustaría mejorar primero?', hint: '(captación, fidelización, automatización, métricas, etc.)' },
            [AREAS.OPERACIONES]: { q: '¿Cuál es la parte más complicada de entregar tu servicio o producto?', hint: '(errores, retrasos, tareas repetitivas, coordinación, etc.)' },
            [AREAS.ADMINISTRACION]: { q: '¿Qué te quita más tiempo o genera más errores en tu gestión administrativa?', hint: '(facturas, métricas, reportes, cobros, etc.)' }
        };

        function updateProgress() {
            const totalSteps = questionFlow.length;
            const progress = totalSteps > 0 ? Math.round((currentStep / totalSteps) * 100) : 0;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
        }

        function buildQuestionFlow() {
            questionFlow = ['sector', 'prioridad', 'detalle_prioridad'];
            const sector = answers.sector;
            const prioridad = answers.prioridad;

            // Orden de áreas: primero la prioritaria, luego las demás
            const areasOrden = [prioridad];
            Object.values(AREAS).forEach(a => { if (a !== prioridad) areasOrden.push(a); });

            areasOrden.forEach(area => {
                questionFlow.push(`area_${area}`);
            });

            questionFlow.push('pregunta_final', 'contacto');
        }

        function getAreaQuestions(area, sector) {
            switch (area) {
                case AREAS.VENTAS: return PREGUNTAS_VENTAS[sector] || [];
                case AREAS.MARKETING: return PREGUNTAS_MARKETING[sector] || [];
                case AREAS.OPERACIONES: return PREGUNTAS_OPS[sector] || [];
                case AREAS.ADMINISTRACION: return PREGUNTAS_ADMIN[sector] || [];
                default: return [];
            }
        }

        function renderStep() {
            updateProgress();
            const stepId = questionFlow[currentStep];

            if (stepId === 'sector') renderSector();
            else if (stepId === 'prioridad') renderPrioridad();
            else if (stepId === 'detalle_prioridad') renderDetallePrioridad();
            else if (stepId.startsWith('area_')) renderAreaQuestions(stepId.replace('area_', ''));
            else if (stepId === 'pregunta_final') renderPreguntaFinal();
            else if (stepId === 'contacto') renderContacto();
        }

        function renderSector() {
            container.innerHTML = `
                <p class="section-label">Sector del negocio</p>
                <h3 class="question-title">¿Qué tipo de empresa tienes?</h3>
                <div class="options-container">
                    <button class="option-btn" data-value="${SECTORES.RESTAURANTE}">Restaurante / Hostelería</button>
                    <button class="option-btn" data-value="${SECTORES.ECOMMERCE}">E-commerce</button>
                    <button class="option-btn" data-value="${SECTORES.SERVICIOS}">Servicios profesionales (clínica, peluquería, gimnasios...)</button>
                    <button class="option-btn" data-value="${SECTORES.OTRO}">Otro</button>
                </div>
                <input type="text" class="text-input" id="other-input" placeholder="Especifica tu tipo de empresa..." style="display:none; margin-top: 20px;">
                <div class="nav-buttons"><div></div><button class="nav-btn next" id="btn-next" disabled>Siguiente →</button></div>
            `;

            const otherInput = document.getElementById('other-input');
            const nextBtn = document.getElementById('btn-next');

            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    answers.sector = btn.dataset.value;

                    if (btn.dataset.value === SECTORES.OTRO) {
                        otherInput.style.display = 'block';
                        otherInput.focus();
                        nextBtn.disabled = !otherInput.value.trim();
                    } else {
                        otherInput.style.display = 'none';
                        nextBtn.disabled = false;
                    }
                };
            });

            otherInput.oninput = () => {
                answers.sector_detalle = otherInput.value.trim();
                nextBtn.disabled = !otherInput.value.trim();
            };

            nextBtn.onclick = () => {
                currentStep++;
                renderStep();
            };
        }

        function renderPrioridad() {
            container.innerHTML = `
                <p class="section-label">Bloque de prioridad</p>
                <h3 class="question-title">¿Qué área te gustaría priorizar para mejorar primero?</h3>
                <div class="options-container">
                    <button class="option-btn" data-value="${AREAS.VENTAS}">Ventas</button>
                    <button class="option-btn" data-value="${AREAS.MARKETING}">Marketing</button>
                    <button class="option-btn" data-value="${AREAS.OPERACIONES}">Operaciones / Fulfillment</button>
                    <button class="option-btn" data-value="${AREAS.ADMINISTRACION}">Administración</button>
                </div>
                <div class="nav-buttons"><button class="nav-btn back" id="btn-back">← Atrás</button><button class="nav-btn next" id="btn-next" disabled>Siguiente →</button></div>
            `;
            setupSingleSelect('prioridad');
            document.getElementById('btn-back').onclick = () => { currentStep--; renderStep(); };
        }

        function renderDetallePrioridad() {
            const prioridad = answers.prioridad;
            const info = DETALLE_AREA[prioridad];
            container.innerHTML = `
                <p class="section-label">Detalle de ${prioridad}</p>
                <h3 class="question-title">${info.q}</h3>
                <p class="question-subtitle">${info.hint}</p>
                <textarea class="textarea-input" id="detalle-input" placeholder="Describe tu situación..."></textarea>
                <div class="nav-buttons"><button class="nav-btn back" id="btn-back">← Atrás</button><button class="nav-btn next" id="btn-next">Siguiente →</button></div>
            `;
            document.getElementById('btn-back').onclick = () => { currentStep--; renderStep(); };
            document.getElementById('btn-next').onclick = () => {
                const detalle = document.getElementById('detalle-input').value.trim();
                if (!detalle) {
                    alert('Por favor, describe tu situación antes de continuar.');
                    return;
                }
                answers.detalle_prioridad = detalle;
                buildQuestionFlow();
                currentStep++;
                renderStep();
            };
        }

        function renderAreaQuestions(area) {
            const sector = answers.sector;
            const preguntas = getAreaQuestions(area, sector);
            const areaNames = { ventas: 'Ventas', marketing: 'Marketing', operaciones: 'Operaciones / Fulfillment', administracion: 'Administración' };

            if (!answers.areas) answers.areas = {};
            if (!answers.areas[area]) answers.areas[area] = {};

            let html = `<p class="section-label">${areaNames[area]}</p>`;

            preguntas.forEach((p, i) => {
                html += `<div class="section-divider"><h3 class="question-title">${p.q}</h3>`;
                if (p.type === 'single') {
                    html += `<div class="options-container" data-qid="${p.id}" data-type="single">`;
                    p.opts.forEach(opt => {
                        html += `<button class="option-btn area-opt" data-qid="${p.id}" data-value="${opt}">${opt}</button>`;
                    });
                    html += `</div>`;
                } else if (p.type === 'conditional') {
                    html += `<div class="options-container" data-qid="${p.id}" data-type="conditional" data-trigger="${p.subQ.trigger}">`;
                    p.opts.forEach(opt => {
                        html += `<button class="option-btn area-opt conditional-main" data-qid="${p.id}" data-value="${opt}">${opt}</button>`;
                    });
                    html += `</div>`;
                    html += `<div class="sub-question" id="sub-${p.id}" style="display:none; margin-top:15px; padding-left:20px; border-left:3px solid #47a2e8;">`;
                    html += `<h4 style="color:#ccc; margin-bottom:10px;">${p.subQ.q}</h4>`;
                    html += `<div class="options-container" data-qid="${p.subQ.id}" data-type="single">`;
                    p.subQ.opts.forEach(opt => {
                        html += `<button class="option-btn area-opt sub-opt" data-qid="${p.subQ.id}" data-value="${opt}">${opt}</button>`;
                    });
                    html += `</div></div>`;
                } else {
                    html += `<div class="checkbox-group" data-qid="${p.id}" data-type="multi">`;
                    p.opts.forEach(opt => {
                        html += `<label class="checkbox-item" data-qid="${p.id}" data-value="${opt}"><input type="checkbox"><span>${opt}</span></label>`;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
            });

            html += `<div class="nav-buttons"><button class="nav-btn back" id="btn-back">← Atrás</button><button class="nav-btn next" id="btn-next">Siguiente →</button></div>`;
            container.innerHTML = html;

            // Single select handlers (including conditional main options)
            document.querySelectorAll('.area-opt:not(.sub-opt)').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    const qid = btn.dataset.qid;
                    document.querySelectorAll(`.area-opt[data-qid="${qid}"]:not(.sub-opt)`).forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    answers.areas[area][qid] = btn.dataset.value;

                    // Handle conditional sub-question visibility
                    const container = btn.closest('[data-type="conditional"]');
                    if (container) {
                        const trigger = container.dataset.trigger;
                        const subQ = document.getElementById(`sub-${qid}`);
                        if (subQ) {
                            if (btn.dataset.value === trigger) {
                                subQ.style.display = 'block';
                            } else {
                                subQ.style.display = 'none';
                                // Clear sub-answer if hidden
                                const subQid = subQ.querySelector('[data-qid]')?.dataset.qid;
                                if (subQid) delete answers.areas[area][subQid];
                                subQ.querySelectorAll('.sub-opt').forEach(b => b.classList.remove('selected'));
                            }
                        }
                    }
                };
            });

            // Sub-option handlers
            document.querySelectorAll('.sub-opt').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    const qid = btn.dataset.qid;
                    document.querySelectorAll(`.sub-opt[data-qid="${qid}"]`).forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    answers.areas[area][qid] = btn.dataset.value;
                };
            });

            // Multi select handlers - Fixed
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    item.classList.toggle('selected');
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = item.classList.contains('selected');
                    const qid = item.dataset.qid;
                    const selected = [...document.querySelectorAll(`.checkbox-item.selected[data-qid="${qid}"]`)].map(i => i.dataset.value);
                    answers.areas[area][qid] = selected;
                };
            });

            document.getElementById('btn-back').onclick = () => { currentStep--; renderStep(); };
            document.getElementById('btn-next').onclick = () => {
                // Validar que todas las preguntas estén respondidas
                let allAnswered = true;
                preguntas.forEach(p => {
                    const answer = answers.areas[area][p.id];
                    if (!answer || (Array.isArray(answer) && answer.length === 0)) {
                        allAnswered = false;
                    }
                    // Validar subpregunta condicional si está visible
                    if (p.type === 'conditional' && answer === p.subQ.trigger) {
                        const subAnswer = answers.areas[area][p.subQ.id];
                        if (!subAnswer) {
                            allAnswered = false;
                        }
                    }
                });
                if (!allAnswered) {
                    alert('Por favor, responde todas las preguntas antes de continuar.');
                    return;
                }
                currentStep++;
                renderStep();
            };
        }

        function renderPreguntaFinal() {
            container.innerHTML = `
                <p class="section-label">Pregunta final — Prioridad de acción</p>
                <h3 class="question-title">Si pudieras automatizar o mejorar una sola cosa ahora mismo, ¿cuál sería?</h3>
                <textarea class="textarea-input" id="final-input" placeholder="Escribe aquí tu respuesta..."></textarea>
                <div class="nav-buttons"><button class="nav-btn back" id="btn-back">← Atrás</button><button class="nav-btn next" id="btn-next">Siguiente →</button></div>
            `;
            document.getElementById('btn-back').onclick = () => { currentStep--; renderStep(); };
            document.getElementById('btn-next').onclick = () => {
                const respuesta = document.getElementById('final-input').value.trim();
                if (!respuesta) {
                    alert('Por favor, escribe tu respuesta antes de continuar.');
                    return;
                }
                answers.pregunta_final = respuesta;
                currentStep++;
                renderStep();
            };
        }

        function renderContacto() {
            container.innerHTML = `
                <p class="section-label">Contacto</p>
                <h3 class="question-title">¡Último paso! Déjanos tus datos de contacto</h3>
                <div class="privacy-note">Usaremos estos datos solo para enviarte el análisis y coordinar la llamada.</div>
                <div class="contact-field"><label>Nombre completo *</label><input type="text" id="c-nombre" placeholder="Tu nombre" required></div>
                <div class="contact-field"><label>Email *</label><input type="email" id="c-email" placeholder="email@empresa.com" required></div>
                <div class="contact-field"><label>Teléfono *</label><input type="tel" id="c-telefono" placeholder="600 000 000" required></div>
                <div class="nav-buttons"><button class="nav-btn back" id="btn-back">← Atrás</button><button class="submit-btn" id="btn-submit" style="flex:1;">Enviar diagnóstico</button></div>
            `;
            document.getElementById('btn-back').onclick = () => { currentStep--; renderStep(); };
            document.getElementById('btn-submit').onclick = submitDiagnostic;
        }

        function setupSingleSelect(key) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    answers[key] = btn.dataset.value;
                    document.getElementById('btn-next').disabled = false;
                };
            });
            document.getElementById('btn-next').onclick = () => {
                if (!answers[key]) return;
                if (key === 'prioridad') buildQuestionFlow();
                currentStep++;
                renderStep();
            };
        }

        async function submitDiagnostic() {
            const nombre = document.getElementById('c-nombre').value;
            const email = document.getElementById('c-email').value;
            const telefono = document.getElementById('c-telefono').value;

            if (!nombre || !email || !telefono) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }

            const submitBtn = document.getElementById('btn-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            const data = { ...answers, nombre, email, telefono, fecha: new Date().toISOString() };
            console.log('Diagnostic data:', data);

            try {
                const response = await fetch('http://localhost:5678/webhook/formulario-diagnostico', {
                    method: 'POST', mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    progressFill.style.width = '100%';
                    progressText.textContent = '100%';
                    container.innerHTML = `
                        <div class="success-message">
                            <h2>✓ ¡Diagnóstico enviado!</h2>
                            <p>Hemos recibido tu información correctamente.</p>
                            <p style="margin-top: 15px;">Analizaremos tus respuestas y te contactaremos con el análisis personalizado.</p>
                            <a href="index.html" style="display: inline-block; margin-top: 30px; color: #47a2e8; text-decoration: underline;">Volver al inicio</a>
                        </div>
                    `;
                } else throw new Error('Error');
            } catch (error) {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar diagnóstico';
                alert('Error al enviar. Inténtalo de nuevo.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            questionFlow = ['sector', 'prioridad'];
            setTimeout(() => { renderStep(); }, 800);
        });
    </script>
    <script>
        window.CHATBOT_ENDPOINT = "http://localhost:5678/webhook/3381e020-7a56-4240-a876-1a837682a5eb";
    </script>
    <script src="./chat-widget.js"></script>
</body>

</html>